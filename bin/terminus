#!/usr/bin/env ruby

require 'rubygems'
require 'oyster'
require File.expand_path(File.dirname(__FILE__) + '/../lib/terminus')

spec = Oyster.spec do
  name "terminus -- controll web browsers from the command line"
  synopsis "terminus [--port PORT]"
  
  integer :port, :default => Terminus::DEFAULT_PORT
end

begin
  options = spec.parse
  app = Terminus.create(options)
  
  app.run!
  puts "Terminus server running on port #{options[:port]}"
  puts "Press CTRL-C to exit"
  puts ""
  
  trap("INT") { app.stop! ; exit }
  
  begin
    require 'readline'
    
    puts "This is the Terminus console. You can type JavaScript"
    puts "in here and it will be executed on all connected pages."
    puts ""
    
    loop {
      script, result = Readline.readline('>> '), nil
      Readline::HISTORY.push(script)
      app.execute(script) { |r| result = r }
    }
  rescue LoadError
    puts "If you install the readline library, you'll get a console"
    puts "that lets you execute JavaScript in connected browsers."
    puts ""
  end
  
rescue Oyster::HelpRendered
end

