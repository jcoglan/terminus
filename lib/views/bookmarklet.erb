(function() {
  var faye = '<%= ::Terminus::FAYE_MOUNT %>',
      host = '<%= host %>';
  
  JSCLASS_PATH = host + '/js.class/';
  
  var withPackageManager = function(callback) {
    if (window.JS && JS.Packages) return callback();
    
    var script = document.createElement('script'),
        head   = document.getElementsByTagName('head')[0];
    
    script.type = 'text/javascript';
    script.src  = host + '/loader.js';
    
    script.onload = script.onreadystatechange = function() {
      var state = script.readyState;
      if (!state || state === 'loaded' || state === 'complete') {
        script.onload = script.onreadystatechange = null;
        head.removeChild(script);
        callback();
      }
    };
    head.appendChild(script);
  };
  
  withPackageManager(function() {
    JS.Packages(function() { with(this) {
      file(host + faye + '/client.js')
        .provides('Faye', 'Faye.Client')
        .setup(function() { Faye.Client.prototype.MAX_DELAY = 0 });
      
      loader(function(callback) {
        if (!window.steal) window.steal = {then: function(fn) { fn() }};
        load(host + '/syn/synthetic.js', function() {
          load(host + '/syn/mouse.js', function() {
            load(host + '/syn/browsers.js', function() {
              load(host + '/syn/key.js', function() {
                load(host + '/syn/drag/drag.js', callback);
              });
            });
          });
        });
        
      }).provides('Syn');
      
      file(host + '/terminus.js')
        .requires('Faye.Client', 'document.evaluate', 'Syn')
        .provides('Terminus');
    }});
    
    JS.require('Terminus', function() {
      Terminus.connect(host + faye);
    });
  });
})();

